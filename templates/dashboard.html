{% extends "base.html" %}

{% block title %}System Dashboard{% endblock %}

{% block content %}
<div style="max-width: 800px; margin: 2rem auto; text-align: center;">
    <div style="background-color: #1a1a1a; padding: 1.5rem; border: 1px solid #333; border-radius: 6px;">
        <p>
            Hey, you’ve discovered the dashboard page! This page pulls real-time data from my AWS server and displays it right here on the page using Flask and JavaScript.
        </p>
        <p>
            You’ll find system info, resource usage, top processes, and network interface status, all served live from the backend.
        </p>
    </div>
</div>


<h2>Live System Stats</h2>

<div id="system-info"></div>
<div id="health"></div>
<div id="processes"></div>
<div id="network"></div>

<script>
async function fetchAndDisplay(endpoint, targetId, formatter) {
    try {
        const response = await fetch(endpoint);
        const data = await response.json();
        document.getElementById(targetId).innerHTML = formatter(data);
    } catch (err) {
        document.getElementById(targetId).innerHTML = `<p>Error loading ${endpoint}</p>`;
    }
}

function formatSystemInfo(data) {
    return `
        <h3>System Info</h3>
        <ul>
            <li><strong>Hostname:</strong> my-dashboard <em>(Masked for security)</em></li>
            <li><strong>OS:</strong> Ubuntu 22.04 LTS <em>(Removed kernel version for security)</em></li>
            <li><strong>Python:</strong> ${data.python_version}</li>
            <li><strong>Uptime:</strong> ${data.uptime}</li>
        </ul>`;
}

function formatHealth(data) {
    return `
        <h3>System Health</h3>
        <ul>
            <li><strong>CPU Usage:</strong> ${data.cpu_usage_percent}</li>
            <li><strong>Memory Usage:</strong> ${data.memory_usage_percent}</li>
            <li><strong>Disk Usage:</strong> ${data.disk_usage_percent}</li>
        </ul>`;
}

function formatProcesses(data) {
    return `
        <h3>Top Processes</h3>
        <table>
            <thead><tr><th>PID</th><th>Name</th><th>Memory %</th></tr></thead>
            <tbody>
                ${data.map(p => `<tr><td>${p.pid}</td><td>${p.name}</td><td>${p.memory_percent}</td></tr>`).join("")}
            </tbody>
        </table>`;
}

function formatNetwork(data) {
    const interfaces = Object.entries(data.interfaces).map(([iface, val]) => {
        const maskedIps = val.ip_addresses.map(() => "Private (Masked for security)").join(", ");
        return `<li><strong>${iface}</strong>: ${maskedIps}</li>`;
    }).join("");

    const status = Object.entries(data.interface_status).map(([iface, up]) => {
        return `<li><strong>${iface}</strong>: ${up ? "Up" : "Down"}</li>`;
    }).join("");

    return `
        <h3>Network Interfaces</h3>
        <ul>${interfaces}</ul>
        <h4>Status</h4>
        <ul>${status}</ul>`;
}

fetchAndDisplay("/api/info", "system-info", formatSystemInfo);
fetchAndDisplay("/api/health", "health", formatHealth);
fetchAndDisplay("/api/processes", "processes", formatProcesses);
fetchAndDisplay("/api/network", "network", formatNetwork);
</script>

<p style="margin-top: 2rem;">
    View <a href="/dashboard/apilogs">API Access Logs</a>
</p>

{% endblock %}
